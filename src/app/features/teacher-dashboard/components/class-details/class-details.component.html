<!-- Student Notes Section -->
<div *ngIf="studentNotes.length > 0" class="student-notes-section">
  <h3>Notes des élèves pour la matière sélectionnée</h3>
  <ul>
    <li *ngFor="let note of studentNotes">
      <strong>
        <ng-container *ngIf="note.student?.profilePictureUrl; else noProfile">
          <img [src]="note.student.profilePictureUrl" alt="Photo de profil" class="student-profile-img"
               style="width:32px;height:32px;border-radius:50%;margin-right:8px;vertical-align:middle;object-fit:cover;"/>
        </ng-container>
        <ng-template #noProfile>
          <i class="fas fa-user" style="margin-right:8px;"></i>
        </ng-template>
        {{ note.student?.user_model?.first_name }} {{ note.student?.user_model?.last_name }}
        ({{ note.student?.matricule }})
      </strong>
      <span *ngFor="let grade of note.grades">
        | {{ grade.type }}: <b>{{ grade.mark }}</b>
      </span>
    </li>
  </ul>
</div>
<div *ngIf="studentNotes.length === 0">
  <p>Aucune note trouvée pour cette matière.</p>
</div>
<div class="card class-details-card">
  <div class="card-header">
    <h2 class="card-title">Feuille de note de la classe de {{ currentClass?.name }}</h2>
  </div>
  <div class="card-content">
    <h3 class="section-title">Notes des Étudiants</h3>
    <p *ngIf="students.length === 0" class="no-data-message">Aucun étudiant trouvé pour cette classe.</p>

    <div *ngIf="loading" class="loading-message">Chargement en cours...</div>
    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

    <div class="table-responsive" *ngIf="students.length > 0">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom de l'Étudiant</th>
            <ng-container *ngFor="let assignment of assignements">
              <th *ngFor="let type of gradeTypes">
                {{ subjectIdToSubject[assignment.subject_id]?.name || 'Matière inconnue' }} ({{ type | titlecase }})
              </th>
            </ng-container>
            <th>Info</th>
          </tr>
        </thead>
        <tbody>
        <tr *ngFor="let student of students">
          <td>{{ student.userModel!.first_name }} {{ student.userModel!.last_name }}</td>
          <ng-container *ngFor="let assignment of assignements">
            <td *ngFor="let type of gradeTypes">
              <ng-container *ngIf="student.latest_student_session?.id as sessionId">
                <input type="number" min="0" max="20" step="1" class="form-control grade-input"
                       [value]="getGrade(sessionId, assignment.id, type)"
                       (change)="updateGrades(sessionId, assignment.id, type, $event)"
                       [placeholder]="'Saisir...'"
                       [disabled]="!sessionId">
              </ng-container>
              <ng-container *ngIf="!student.latest_student_session?.id">
                <span class="text-danger small">No session ID</span>
              </ng-container>
            </td>
          </ng-container>
          <td>
              <button class="btn btn-icon" (click)="showStudentInfo(student)">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" (click)="saveGrades()">Enregistrer les Notes</button>
      <button class="btn btn-secondary" (click)="submitTermGrades()">Soumettre les Notes du Terme</button>
    </div>
  </div>
</div>
